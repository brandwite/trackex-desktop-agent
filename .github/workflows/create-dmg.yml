name: Create DMG from Stapled App

on:
  workflow_dispatch:

jobs:
  create-dmg:
    runs-on: macos-latest

    steps:
      # Checkout repository (required by actions)
      - name: Checkout repository
        uses: actions/checkout@v4

      # âœ… Download the stapled app artifact from the previous workflow
      - name: Download stapled-app artifact
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: staple-latest.yml      # <- the workflow that uploaded stapled-app
          workflow_conclusion: success
          name: stapled-app
          path: ./downloaded

      # âœ… Rebuild the .app bundle from the extracted "Contents" folder
      - name: Prepare stapled app
        run: |
          echo "ðŸ“‚ Listing downloaded contents..."
          ls -R downloaded

          if [ -d "downloaded/Contents" ]; then
            echo "ðŸ§© Detected unzipped app contents. Rebuilding .app bundle..."
            mkdir -p "TrackEx Agent.app"
            mv downloaded/Contents "TrackEx Agent.app/"
          elif [ -d "downloaded/TrackEx Agent.app" ]; then
            echo "âœ… Detected .app structure already."
            mv downloaded/TrackEx\ Agent.app .
          else
            echo "âŒ Could not find expected app structure in artifact."
            exit 1
          fi

          echo "âœ… .app bundle ready:"
          ls -R "TrackEx Agent.app"

      # âœ… Create the DMG file from the .app
      - name: Create DMG
        run: |
          echo "ðŸ’¿ Creating DMG from stapled app..."
          hdiutil create -volname "TrackEx Agent" \
            -srcfolder "TrackEx Agent.app" \
            -ov -format UDZO "TrackEx Agent.dmg"
          echo "âœ… DMG created successfully:"
          ls -lh "TrackEx Agent.dmg"

      # âœ… Upload the resulting DMG file as an artifact
      - name: Upload DMG
        uses: actions/upload-artifact@v4
        with:
          name: stapled-dmg
          path: TrackEx Agent.dmg
